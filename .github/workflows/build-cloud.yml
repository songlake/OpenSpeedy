name: Build OpenSpeedy (64-bit Cloud)

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build64:
    runs-on: windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        choco install visualstudio2022buildtools visualstudio2022-workload-vctools cmake ninja -y
        python -m pip install --upgrade pip
        pip install aqtinstall
        # 安装 Qt 5.15.2 MSVC2019 64-bit
        python -m aqt install-qt windows desktop 5.15.2 win64_msvc2019_64 --outputdir C:\Qt
        echo "QT_DIR=C:\Qt\5.15.2\msvc2019_64" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "CMAKE_PREFIX_PATH=C:\Qt\5.15.2\msvc2019_64" | Out-File -FilePath $env:GITHUB_ENV -Append

    - name: Build
      shell: cmd
      run: |
        call "%QT_DIR%\bin\qtenv2.bat"
        cmake -B build -S . -G "Ninja" -DCMAKE_BUILD_TYPE=Release
        cmake --build build --config Release

    - name: Collect artifacts
      run: |
        mkdir artifacts
        copy build\*.exe artifacts\
        copy build\*.dll artifacts\

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OpenSpeedy-64bit
        path: artifacts/
